# Writing first SQL queries

## –ù–∞–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã—Ö

1. Titanic Data description

```
Pclass ‚Äî –∫–ª–∞—Å—Å –ø–∞—Å—Å–∞–∂–∏—Ä–∞ (1 ‚Äî –≤—ã—Å—à–∏–π, 2 ‚Äî —Å—Ä–µ–¥–Ω–∏–π, 3 ‚Äî –Ω–∏–∑—à–∏–π);
Name ‚Äî –∏–º—è;
Sex ‚Äî –ø–æ–ª;
Age ‚Äî –≤–æ–∑—Ä–∞—Å—Ç;
SibSp ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–∞—Ç—å–µ–≤, —Å–µ—Å—Ç–µ—Ä, —Å–≤–æ–¥–Ω—ã—Ö –±—Ä–∞—Ç—å–µ–≤, —Å–≤–æ–¥–Ω—ã—Ö —Å–µ—Å—Ç–µ—Ä, —Å—É–ø—Ä—É–≥–æ–≤ –Ω–∞ –±–æ—Ä—Ç—É —Ç–∏—Ç–∞–Ω–∏–∫–∞;
Parch ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–¥–∏—Ç–µ–ª–µ–π, –¥–µ—Ç–µ–π (–≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–∏–µ–º–Ω—ã—Ö) –Ω–∞ –±–æ—Ä—Ç—É —Ç–∏—Ç–∞–Ω–∏–∫–∞;
Ticket ‚Äî –Ω–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞;
Fare ‚Äî –ø–ª–∞—Ç–∞ –∑–∞ –ø—Ä–æ–µ–∑–¥;
Cabin ‚Äî –∫–∞—é—Ç–∞;
Embarked ‚Äî –ø–æ—Ä—Ç –ø–æ—Å–∞–¥–∫–∏ (C ‚Äî –®–µ—Ä–±—É—Ä; Q ‚Äî –ö–≤–∏–Ω—Å—Ç–∞—É–Ω; S ‚Äî –°–∞—É—Ç–≥–µ–º–ø—Ç–æ–Ω).
```

2. Games

```
Rank - –†–µ–π—Ç–∏–Ω–≥ –æ–±—â–∏—Ö –ø—Ä–æ–¥–∞–∂
Name - –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã
Platform - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∞ –≤—ã–ø—É—â–µ–Ω–∞ –∏–≥—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, PC, PS4 –∏ —Ç.–¥.)
Year - –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –∏–≥—Ä—ã
Genre - –ñ–∞–Ω—Ä –∏–≥—Ä—ã
Publisher - –ò–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã
NA_Sales - –ü—Ä–æ–¥–∞–∂–∏ –≤ –°–µ–≤–µ—Ä–Ω–æ–π –ê–º–µ—Ä–∏–∫–µ (–≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö)
EU_Sales - –ü—Ä–æ–¥–∞–∂–∏ –≤ –ï–≤—Ä–æ–ø–µ (–≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö)
JP_Sales - –ü—Ä–æ–¥–∞–∂–∏ –≤ –Ø–ø–æ–Ω–∏–∏ (–≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö)
Other_Sales - –ü—Ä–æ–¥–∞–∂–∏ –≤ –æ—Å—Ç–∞–ª—å–Ω–æ–º –º–∏—Ä–µ (–≤ –º–∏–ª–ª–∏–æ–Ω–∞—Ö)
Global_Sales - –û–±—â–∏–µ –º–∏—Ä–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏.
```

–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É:

```sql
CREATE TABLE video_game_sales (
    Rank UInt32,
    Name String,
    Platform String,
    Year String,
    Genre String,
    Publisher String,
    NA_Sales Float32,
    EU_Sales Float32,
    JP_Sales Float32,
    Other_Sales Float32,
    Global_Sales Float32
) ENGINE = Log
```

–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ:

```sql
INSERT INTO video_game_sales SELECT * FROM url('https://raw.githubusercontent.com/dmitrii12334/clickhouse/main/vgsale', CSVWithNames, 'Rank UInt32,
    Name String,
    Platform String,
    Year String,
    Genre String,
    Publisher String,
    NA_Sales Float32,
    EU_Sales Float32,
    JP_Sales Float32,
    Other_Sales Float32,
    Global_Sales Float32');
```

### –ò –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. Kinopoisk Parsing

3.1 [Download data](https://github.com/urevoleg/course-clickhouse-analytics/tree/main/data)
3.2 –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–ø–∫—É `/var/lib/clickhouse/user_files` (clickhouse –ø–æ–¥–Ω—è—Ç –≤ –¥–æ–∫–µ—Ä–µ)

–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É:
```sql
CREATE TABLE kinopoisk_parsing_result (
    id UInt32,
    search_item String,
    search_url String,
    film_id UInt32,
    film_url String,
    film_name String,
    production_year String,
    country String,
    genre String,
    director String,
    screenwriter String,
    operator String,
    compositor String,
    painter String,
    mount String,
    budget String,
    box_office_usa String,
    box_office_world String,
    box_office_russia String,
    rating_kp_top Float,
    marks_amount_kinopoisk String,
    rating_kp_pos String,
    rating_kp_neu String,
    rating_kp_neg String,
    rating_imbd String,
    marks_amount_imbd String,
    release_world String,
    release_russia String,
    digital_release String,
    checked_at String,
    error String,
    poster_link String,
    film_descr String
) ENGINE = Log;
```

–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:

```sql
INSERT INTO kinopoisk_parsing_result
SELECT * FROM file('/var/lib/clickhouse/user_files/kinopoisk_parsing_clear.csv', CSV, 'id UInt32,
    search_item String,
    search_url String,
    film_id UInt32,
    film_url String,
    film_name String,
    production_year String,
    country String,
    genre String,
    director String,
    screenwriter String,
    operator String,
    compositor String,
    painter String,
    mount String,
    budget String,
    box_office_usa String,
    box_office_world String,
    box_office_russia String,
    rating_kp_top Float,
    marks_amount_kinopoisk String,
    rating_kp_pos String,
    rating_kp_neu String,
    rating_kp_neg String,
    rating_imbd String,
    marks_amount_imbd String,
    release_world String,
    release_russia String,
    digital_release String,
    checked_at String,
    error String,
    poster_link String,
    film_descr String');
```

## –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Clickhouse

Clickhouse –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ SQL –∫–æ–º–∞–Ω–¥—ã:
- `SELECT`
- `FROM`
- `JOIN`
- `GROUP BY`
- `LIMIT`
- `ORDER BY`
- `WHERE`
- `HAVING`
- `WITH`
- `UNION`
- –∏ –¥—Ä

–¢–∞–∫–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∏–Ω—Ç—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
- `SAMPLE` - —Å–µ–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞—Å—á–µ—Ç—ã –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ
- `PREWHERE` - —ç—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. –û–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–∫—Ü–∏—è PREWHERE —è–≤–Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω–∞. 
–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —á–∞—Å—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏–∑ WHERE –¥–æ —Å—Ç–∞–¥–∏–∏ prewhere
- `ANY\ALL` - –≤—ã–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–≤–æ–µ –ø–æ–ø–∞–≤—à–µ–µ—Å—è –∑–Ω–∞—á–µ–Ω–∏—è\–ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å—Ç—Ä–æ–∫, —Ç–æ ALL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∏–∑ –Ω–∏—Ö. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ SELECT ALL —Ç–æ—á–Ω–æ —Ç–∞–∫–æ–µ –∂–µ, –∫–∞–∫ –∏ SELECT –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ DISTINCT.
- `AS OF`

‚òùÔ∏èUPPER\lower CASE –Ω–µ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ —è–∑—ã–∫–∞ SQL, –Ω–æ –≤–∞—Ä–∏–∞—Ç –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ñ—É–∫–Ω—Ü–∏–π –¥–æ–ª–∂–µ–Ω–∏ —Å–æ–±–ª—é–¥–∞—Ç—å—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
`JSONExtractString` != `jsonsxtractstring` 

**–í—ã–≥—Ä—É–∑–∫–∞ –≤ —Ñ–∞–π–ª**

```sql
SELECT * # –í—ã–±–æ—Ä —Å—Ç–æ–ª–±—Üa
FROM table1 # –ò–∑ –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã
ORDER BY id DESC # –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
LIMIT 5 # –û–±—Ä–µ–∑–∞–µ–º —Å–≤–µ—Ä—Ö—É
INTO OUTFILE filename # –í—ã–≥—Ä—É–∑–∫–∞ –≤ —Ñ–∞–π–ª
FORMAT CSVWithNames # –§–æ—Ä–º–∞—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```

–ü—Ä–æ–±—É–µ–º - `sql/staging/dump_into_file.sql`

–ö–æ–º–∞–Ω–¥–∞ `INTO OUTFILE` –∏–º–µ–µ—Ç –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö: –∫–ª–∏–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ clickhouse-local. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∑–∞–ø—Ä–æ—Å, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —á–µ—Ä–µ–∑ HTTP –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É.
- –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ —Ñ–∞–π–ª —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç TabSeparated (–∫–∞–∫ –≤ –ø–∞–∫–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–ª–∏–µ–Ω—Ç–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏). 
- –ï–≥–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Å–µ–∫—Ü–∏–∏ FORMAT

–ß—Ç–æ–±—ã –ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. –ó–∞—Ö–æ–¥–∏–º –≤ clickhouse

```
docker exec -it clickhouse-server /bin/bash
```

2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤

```
cd //var/lib/clickhouse/user_files
```

3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑ `sql/staging/dump_into_file.sql` –≤ —Ñ–∞–π–ª `top_genres.sql`

```
nano top_genres.sql # –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
```

4. –í—ã–ø–æ–ª–Ω—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é)

```
clickhouse-client --user your_user_name --password your_user_pass --queries-file top_genres.sql
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏, –≤—Å—ë –Ω–∞ –º–µ—Å—Ç–µ:
![into_outfile_top_genres.png](..%2F..%2Fimg%2Finto_outfile_top_genres.png)

 –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã: –¥—Ä–∞–º–∞\–∫–æ–º–µ–¥–∏—è\–±–æ–µ–≤–∏–∫, –∫–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç—Å—è, —Ö–ª–µ–±–∞ –∏ –∑—Ä–µ–ª–∏—â =)


–¢–µ–ø–µ—Ä—å –º—ã –Ω–∞ –æ–¥–∏–Ω —à–∞–∂–æ–∫ –±–ª–∏–∂–µ –∫ –º–∞–≥–∏–∏:
![magic.gif](..%2F..%2Fimg%2Fmagic.gif)


### Tasks

1. 
```–í —Ç–∞–±–ª–∏—Ü–µ titanic –Ω–∞–π—Ç–∏ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ –∫–æ—Ç–æ—Ä—ã–π\
–ñ–µ–Ω—â–∏–Ω–∞
–ü–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å 
–ù–µ –≤—ã–∂–∏–ª–∞
–í –æ—Ç–≤–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ —Å —Å–∞–º—ã–º –±–æ–ª—å—à–∏–º ID
```

```sql
SELECT PassengerId,
       Name
FROM titanic
WHERE Sex = 'female'
and Pclass = 1
and Survived = 0
ORDER BY PassengerId desc
LIMIT 1;
```

2
```–í —Ç–∞–±–ª–∏—Ü–µ titanic –Ω–∞–π–¥–∏—Ç–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞  
–ö–æ—Ç–æ—Ä—ã–π –Ω–µ –≤—ã–∂–∏–ª
–û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ –∏–º–µ–Ω–∏ [A->Z]
–í —Ä–µ—à–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ORDER BY –∏ LIMIT

–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.
```

```sql
SELECT Name
FROM titanic
WHERE Survived = 0
ORDER BY Name asc
LIMIT 1;
```

## –£—Å–ª–æ–≤–Ω—ã–µ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã

–ü–æ–º–∏–º–æ `CASE WHEN` –≤ Clickhouse —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:
- –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä `If(cond, then, else)`: –æ–±–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –≤—ã—á–∏—Å–ª–µ–Ω—ã (–∏ cond –∏ then)
- `multiIf(cond1, then1, cond2, then2, ...., else)`. 

–î–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–æ—Å—Ç—É–ø–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ `AND, OR`, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```sql
If(Pclass='1' OR Pclass='2', 'rich_person', 'cheap_person')
```

### Tasks

1. 
```
–í —Ç–∞–±–ª–∏—Ü–µ titanic —Ä–∞–∑–º–µ—Ç–∏—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∏ –Ω–∞–π—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ —É—Å–ª–æ–≤–∏—é

–°–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü chance_survived –≤ –∫–æ—Ç–æ—Ä–æ–º

–ü–∞—Å—Å–∞–∂–∏—Ä –∫–æ—Ç–æ—Ä—ã–π –∂–µ–Ω—â–∏–Ω–∞ 1 –∏–ª–∏ 2 –∫–ª–∞—Å—Å–∞ –º—ã –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å lucky (–±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –≤—ã–∂–∏—Ç—å)
–ü–∞—Å—Å–∞–∂–∏—Ä –∫–æ—Ç–æ—Ä—ã–π –∂–µ–Ω—â–∏–Ω–∞ 3 –∫–ª–∞—Å—Å–∞ –º—ã –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å fortunate (–æ—á–µ–≤–∏–¥–Ω–æ —á—Ç–æ —à–∞–Ω—Å–æ–≤ –º–µ–Ω—å—à–µ, –Ω–æ –æ–Ω–∏ –µ—Å—Ç—å)
–î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤—å—Ç–µ other
–ù–∞–π—Ç–∏ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞ –∫–æ—Ç–æ—Ä—ã–π

–í –∏–º–µ–Ω–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ Miss
–û–∫–∞–Ω—á–∏–≤–∞–ª—Å—è —Ç–µ–∫—Å—Ç a
–ù–∞—á–∏–Ω–∞–ª—Å—è —Ç–µ–∫—Å—Ç —Å L
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞–ø–∏—Å–∞—Ç—å –∏–º—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–∫–∞–∑–∞–ª—Å—è lucky —Å —Å–∞–º—ã–º –±–æ–ª—å—à–∏–º PassengerId   
```

```sql
select Name,
       multiIf(Sex='female' and Pclass in (1, 2), 'lucky', Sex='female' and Pclass=3, 'fortunate', 'other') as chance_survived
from titanic
where Name like '%Miss%' and Name like '%a' and Name like 'L%'
and chance_survived = 'lucky'
order by PassengerId desc
limit 10;
```

---------------------------------------------
## –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏

–§—É–Ω–∫—Ü–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –º–Ω–æ–≥–æ, –∏–∑ "–ø–æ—Ç—Ä–æ–≥–∞–Ω–Ω—ã—Ö":
- `length` - –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏
- `uppper` - –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –í–ï–†–•–ù–ï–ú–£ —Ä–µ–≥–∏—Å—Ç—Ä—É, –µ—Å—Ç—å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ `upperUTF8`
- `substring(str, start, end)` - –æ–±—Ä–µ–∑–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –ø–æ –±–∞–π—Ç–∞–º, –µ—Å—Ç—å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ `substringUTF8`
- `concat` - —Å–ª–∏—è–Ω–∏–µ —Å—Ç—Ä–æ–∫
- `position(str, pattern)` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Å –∫–æ—Ç–æ—Ä–æ–π –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
- `match(str, pattern)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ _–µ—Å—Ç—å –∏–ª–∏ –Ω–µ—Ç pattern_  –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
- `extract(str, pattern)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏
- `replaceAll(str, —á—Ç–æ –∑–∞–º–µ–Ω—è—Ç—å, –Ω–∞ —á—Ç–æ –∑–∞–º–µ–Ω—è—Ç—å)` - –∑–∞–º–µ–Ω–∞ –ø–æ–¥—Å—Ç—Ä–æ–∫

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å:
- `endsWith(str, ends)`
- `arrayElement(array, index)` - –ø–æ–ª—É—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
- `splitByChar(split_char, str)` - —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É –Ω–∞ —á–∞—Å—Ç–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤


### Tasks

1. 
```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–ó–Ω–∞–ª–∏ –ª–∏ –≤—ã, —á—Ç–æ –Ω–∞ –±–æ—Ä—Ç—É –¢–∏—Ç–∞–Ω–∏–∫–∞ –Ω–∞—Ö–æ–¥–∏–ª–æ—Å—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∏–∑ –í–æ—Å—Ç–æ—á–Ω–æ–π –ï–≤—Ä–æ–ø—ã? 
–î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏—Ö.
–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –∏–∑ –ø–æ–ª—è Name —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å –∏–º–µ–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ –¥–æ Mr –∏–ª–∏ Miss (–¥–µ–ª–µ–Ω–∏–µ –ø–æ , ) –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –Ω–∞ off –∏–ª–∏ eff (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—Ñ—Ñ–∏–∫—Å, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–º —Å–ª–æ–∂–Ω–æ–µ –∏–º—è). –í —ç—Ç–æ–º –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Ñ—É–Ω–∫—Ü–∏—è endsWith(..), –∞ —Ç–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–¥–µ —É–≥–æ–¥–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–∞–∫: or(x=1, y=2)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏ [A->Z] –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –≤—ã–ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—É—é —Ñ–∞–º–∏–ª–∏—é –≤ —Å–ø–∏—Å–∫–µ. –≠—Ç—É –∑–∞–¥–∞—á—É –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –≤—ã –º–æ–∂–µ—Ç–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± —Ä–µ—à–µ–Ω–∏—è.   
```

–î–ª—è —Ç–µ—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è VIEW

```sql
create view titanic_view as select * from titanic order by PassengerId LIMIT 300 OFFSET 300;
```

–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–æ—Ä—Ä–µ—Ç–∫–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –∑–∞–¥–∞—á–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ: **Coleff**

```sql
select arrayElement(splitByChar(',', Name), 1) as first_name_part
from titanic
where or(endsWith(first_name_part, 'off'), endsWith(first_name_part, 'eff'))
order by Name
limit 1;
```

### –¢–∏–ø—ã —Å—Ç—Ä–æ–∫

–í Clickhouse —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫:
- `FixedString` - —Å—Ç—Ä–æ–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ –º–µ—Å—Ç–∞)
- `LowCardinality` - —Ö—Ä–∞–Ω–∏—Ç —Ü–∏—Ñ—Ä–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –∏ –æ—Ç–¥–µ–ª—å–Ω–æ —Å–ª–æ–≤–∞—Ä—å, –Ω–∞–ø—Ä–∏–º–µ—Ä:

–î–ª—è —Ç–∞–∫–æ–π –∫–æ–ª–æ–Ω–∫–∏:
```
| str |
|-----|
| RU  |
| JP  |
| JP  |
| JP  |
| ES  |
| ES  |
| RU  |
```

–ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ:
```
|str |
|----|
| 1  |
| 2  |
| 2  |
| 2  |
| 3  |
| 3  |
| 1  |

–ò –æ—Ç–¥–ª–µ—å–Ω–æ —Å–ª–æ–≤–∞—Ä—å

{'RU': 1, 'JP': 2, 'ES': 3}
```

–£ —Ç–∏–ø–∞ `LowCardinality` –µ—Å—Ç—å –Ω—é–∞–Ω—Å—ã, —á–∏—Ç–∞—Ç—å –≤ [–¥–æ–∫–µ](https://clickhouse.com/docs/ru/sql-reference/data-types/lowcardinality)

–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ + —Å—É—â–µ—Å—Ç–≤—É—é—Ç –º–µ—Ç–æ–¥—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞ –≤ –¥—Ä—É–≥–æ–π.

------------------------------------
## –ß–∏—Å–ª–∞

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∏—Å–µ–ª —ç—Ç–æ Int64, UInt64, Float64, Decimal64, Bool.

–ü—Ä–∏—Å—Ç–∞–≤–∫–∞ 32\64\... –æ–∑–Ω–∞—á–∞–µ—Ç —Ä–∞–∑–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–π —Ç–∏–ø, –Ω–∞–ø—Ä–∏–º–µ—Ä, Int8 = 2^8 = 256. –ü—Ä–∏—Å—Ç–∞–≤–∫–∞ `U` - –æ–∑–Ω–∞—á–∞–µ—Ç `unsigned` - 
—Ç–æ –µ—Å—Ç—å –±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ —á–∏—Å–ª–æ, Uint8 (0, 255), —Ç–æ–≥–¥–∞ –∫–∞–∫ Int8(-127, 128).

–ö–∞–∫ –∏ –ø–æ–ª–æ–∂–µ–Ω–æ –¥–ª—è –≤–µ—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —á–∏—Å–µ–ª `Float` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ—à–∏–±–∫–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è, –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∏–ø `Decimal` (—Å—Ç–æ–∏—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –æ–Ω –º–µ–¥–ª–µ–Ω–Ω–µ–µ),
—Å—Ä–∞–≤–Ω–∏—Ç–µ –¥–≤–∞ –≤—ã–≤–æ–¥–∞ –Ω–∏–∂–µ:

![float_decimal.png](..%2F..%2Fimg%2Ffloat_decimal.png)

–î–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å —Å—É—Ñ—Ñ–∏–∫—Å `..orNull\orZero` - —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è—Ö.

## –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è

![2-file_2019_06_19_11_42_59.jpg](..%2F..%2Fimg%2F2-file_2019_06_19_11_42_59.jpg)

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞:
- `Date` - —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
- `DateTime` - —Ö—Ä–∞–Ω–∏—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∏ –º–æ–∂–Ω–æ –µ—â–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∞–π–º–∑–æ–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, `DateTime('Europe/Moscow')`

–í —Å—Ç–æ–ª–±–µ—Ü —Ç–∏–ø–∞ `DateTime` –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ timestamp (123456789) –∏–ª–∏ —Ç–µ–∫—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ `2020-02-01 01:01:01` - 
—Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—Å—è —Å–∞–º–æ. –°–ª–æ–∂–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π, –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–∞—Å–∏–Ω–≥–∞.

–ù–∞–ø—Ä–∏–º–µ—Ä, –æ–¥–Ω–∞ –∏–∑ —Ñ—É–∫–Ω—Ü–∏–π –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞:
- `parseDateTimeBestEffort`

–¢–∞–∫–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏ (–¥–µ–Ω—å, –≥–æ–¥) –∏ —Ä–∞–∑–Ω–∏—Ü–∞–º–∏ –¥–∞—Ç:
- `toYear` - –≤–µ—Ä–Ω–µ—Ç –≥–æ–¥
- `toStartOfWeek` - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–∞—Ç—É –∫ –Ω–∞—á–∞–ª—É –Ω–µ–¥–µ–ª–∏, –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, —Ç–æ
–ø–∏—à–µ–º `toStartOfWeek(date_columns, 1)`
- –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `now()`, –¥–Ω—è `today()`
- –¥–ª—è —Ä–∞–∑–Ω–∏—Ü—ã –¥–∞—Ç `date_diff`


### Tasks

1.
```
–í —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º –æ—Ç—á–µ—Ç–µ Google Play –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ earnings –æ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π 
–ø–æ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ, –æ–¥–Ω–∞–∫–æ –≤—Ä–µ–º—è –∏ –¥–∞—Ç–∞ –≤ –¥–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ –≤ —Å–∞–º–æ–º —É–¥–æ–±–Ω–æ–º –≤–∏–¥–µ.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏–≤–µ–¥–∏—Ç–µ transaction_id —Å —Å–∞–º–æ–π –±–æ–ª—å—à–æ–π –¥–∞—Ç–æ–π, 
–æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è –ø–æ –¥–∞—Ç–µ, –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –æ—Ç–≤–µ—Ç–æ–º.
```

![datetime_tasks_parse.png](..%2F..%2Fimg%2Fdatetime_tasks_parse.png)


–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –¥–∞–Ω–Ω—ã—Ö:

```sql
CREATE TABLE transactions_log (
    transaction_id String,
    transaction_date String,
    transaction_time String,
    tax_type String,
    transaction_type String,
    refund_type String,
    product_name String,
    product_id String
) ENGINE = Log;
```

–ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏ - –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç [script_1_2_2.sql](sql%2Fstaging%2Fscript_1_2_2.sql)

–¢–µ—Å—Ç–æ–≤–∞—è VIEW
```sql
create view transactions_log_view as select * from transactions_log order by transaction_id limit 50;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–º:
![datetime_google_play_task.png](..%2F..%2Fimg%2Fdatetime_google_play_task.png)

–°–∫—Ä–∏–ø—Ç –æ—Ç–≤–µ—Ç–∞ [task_datetime_parse_answer.sql](sql%2Fstaging%2Ftask_datetime_parse_answer.sql)

-------------------------------------

## –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–¢—Ä–µ–≤–∏–∞–ª—å–Ω—ã–µ –≤–µ—â–∏:
- `GROUP BY`
- `HAVING` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

–ù–µ—Ç—Ä–∏–≤–∞–ª—å–Ω–æ –Ω–∞–ª–∏—á–∏–µ [–∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–æ–≤](https://clickhouse.com/docs/ru/sql-reference/aggregate-functions/combinators) - 
—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å—à–∏—Ä—è—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- `sum -> sumIf(column, cond)` - —Å—É–º–º–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –≥–¥–µ `cond==True`

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–≥–∞—Ç—å –ª–∏—à–Ω–∏—Ö JOIN –∏–ª–∏ subqueries.


### Task

1. 
```
–ú—ã —Å –≤–∞–º–∏ —É–∂–µ –∏–∑—É—á–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é SUM –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫, 
–æ–¥–Ω–∞–∫–æ —Ç–∞–∫–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–Ω–æ–∂–∞—Ç—å —á–∏—Å–ª–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏. 
–í–∞–º –Ω—É–∂–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ —á–∏—Å–ª–µ–Ω–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –∏ —à–∫–æ–ª—å–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É, –∞ —Ç–æ—á–Ω–µ–µ –ª–æ–≥–∞—Ä–∏—Ñ–º—ã.

–†–µ–∑—É–ª—å—Ç–∞—Ç
–í –æ—Ç–≤–µ—Ç –≤–ø–∏—à–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–∏—Å–µ–ª —Å—Ç–æ–ª–±—Ü–∞ PassengerId –û—Ç–≤–µ—Ç –æ–∫—Ä—É–≥–ª–∏—Ç—å –≤–Ω–∏–∑. –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—ã—à–µ
```

```sql
select # –≤–∞—à –∫–æ–¥ #
from titanic 
where PassengerId < 10
```

–ù–∞–ø—Ä—è–≥–ª–∏ ü§Ø –∏ –≤—Å–ø–æ–º–Ω–∏–ª–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤. –û—Ç–≤–µ—Ç –∏—Å–∫–∞—Ç—å [task_prod.sql](sql%2Fstaging%2Ftask_prod.sql)


2. 
```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:

–ü–æ—Å—á–∏—Ç–∞–π—Ç–µ —Å—É–º–º—É –ø—Ä–æ–¥–∞–∂ –ø–æ Global_Sales –ø–æ –≤—Å–µ–º –∏–∑–¥–∞—Ç–µ–ª—è–º, –∫—Ä–æ–º–µ —Ç–æ–ø 5 –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è . 
–ó–∞–¥–∞—á—É –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é not in (select ... from ...) –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –ª–∏—à–Ω–∏—Ö –∏–∑–¥–∞—Ç–µ–ª–µ–π.
–î–ª—è –Ω–∞—á–∞–ª–∞ –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤—Å–µ—Ö –∏–∑–¥–∞—Ç–µ–ª–µ–π –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç 
–≤ —Ç–æ–ø 5 –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è, –ø–æ—Å–ª–µ —á–µ–≥–æ –∏—Å–∫–ª—é—á–∏—Ç—å –∏—Ö –∏–∑ –≤—ã–±–æ—Ä–∫–∏ –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –ø–æ Global_Sales

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–µ–∑ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
```

–û—Ç–≤–µ—Ç —Ç—É—Ç [task_2_sum_global_exclude_top_publisher.sql](sql%2Fstaging%2Ftask_2_sum_global_exclude_top_publisher.sql)

3. 
```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è: –≤ –∫–∞–∫–∏–µ –≥–æ–¥—ã —Ç–æ–ø 5 –∏–∑–¥–∞—Ç–µ–ª–µ–π –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è –ø—Ä–µ–≤—ã—à–∞–ª–∏ 
–ø—Ä–æ–¥–∞–∂–∏ Global_Sales –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 60 –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞. 

–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã sumIf( Global_Sales, publisher not in (SELECT ...))

–ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞:
–ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü - –≥–æ–¥ 
–í—Ç–æ—Ä–æ–π - –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–ø 5 –∏–∑–¥–∞—Ç–µ–ª–µ–π 
–¢—Ä–µ—Ç–∏–π - –ø—Ä–æ–¥–∞–∂–∏ –∫—Ä–æ–º–µ —Ç–æ–ø 5 –∏–∑–¥–∞—Ç–µ–ª–µ–π 
–ß–µ—Ç–≤–µ—Ä—Ç—ã–π - –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É 2 –∏ 3 
–û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –≥–æ–¥–∞–º –∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ —Ç–µ —á—Ç–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —É—Å–ª–æ–≤–∏—é >60
```

–¢–µ—Å—Ç–æ–≤—ã–π VIEW:

```sql
create view video_game_sales_view as select * from video_game_sales limit 200;
```

–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç:
![task_3_global_sales.png](..%2F..%2Fimg%2Ftask_3_global_sales.png)

–í–µ—Ä–Ω—ã–π —Å–∫—Ä–∏–ø—Ç [task_3_global_sales.sql](sql%2Fstaging%2Ftask_3_global_sales.sql)

–í —Ö–æ–¥–µ —Ä–µ—à–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã:
- `groupArray` - –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä `Array`
- `arrayStringConcat` - —Å–∫–ª–µ–π–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞

-----------------------------------
## –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã –∏ CTE

–í clickhouse —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `WITH`, –Ω–æ –æ–Ω–∞ –∏–º–µ–µ—Ç –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è —Ä–µ–∫—É—Ä—Å–∏—è
- —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
- –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ CTE –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö
- ```
   WITH –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –Ω–µ –±—ã–ª–æ –≤ –ö–•, –∞ –∫–æ–≥–¥–∞ –µ–≥–æ –¥–æ–±–∞–≤–∏–ª–∏ –æ–Ω –Ω–µ —É–º–µ–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã, 
  —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –ø–æ—ç—Ç–æ–º—É –≤ –Ω–µ–º –Ω–µ –±—ã–ª–æ —Å–º—ã—Å–ª–∞
  ```
  –ü–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–ª–æ–∂–∏–≤—à–∞—è—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ ClickHouse –¥–ª—è –º–Ω–æ–≥–∏—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, 
—ç—Ç–æ –∏–∑–±–µ–≥–∞—Ç—å WITH –∏ –ø–∏—Å–∞—Ç—å —Å –ø–æ–º–æ—â—å—é –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤. –õ–æ–º–∞–µ–º –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ωüí™ (—Ö–æ—Ç—è –ø–µ—Ä–µ—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ CTE - —ç—Ç–æ **–∂–∏—Ä–Ω—ã–π** –º–∏–Ω—É—Å)

-----------------------------
## –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö NULL, NaN –∏ INF

![nan_null_inf.png](..%2F..%2Fimg%2Fnan_null_inf.png)

### Null

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –º–æ–∂–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤–æ—Ç —Ç–∞–∫ `Nullable(Int64)` - —á—Ç–æ –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Null.
- –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –ø–æ–º–µ—Ç–∫–æ–π –æ Null - –º–∞—Å–∫–∞

**–ü–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `Nullable` —Å–Ω–∏–∂–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —É—á–∏—Ç—ã–≤–∞–π—Ç–µ —ç—Ç–æ –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–≤–æ–∏—Ö –±–∞–∑.**


### NaN\Inf

**NaN** - —á–∏—Å–ª–æ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π Float, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç **–ù–ï –ß–ò–°–õ–û**

**Inf** - –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å

![inf.png](..%2F..%2Fimg%2Finf.png)

### Tasks

1.
```
–ò—Å–ø–æ–ª—å–∑—É—è toFloat64OrNull, –ø–æ—Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Å—Ç–æ–ª–±—Ü–µ Age
```

–°–∫—Ä–∏–ø—Ç –æ—Ç–≤–µ—Ç–∞ [task_2_4_1_age_nulls.sql](sql%2Fstaging%2Ftask_2_4_1_age_nulls.sql)

-----------------------
## JOIN

![join.png](..%2F..%2Fimg%2Fjoin.png)

–¢—É—Ç –±–µ–∑ —Å—é—Ä–ø—Ä–∏–∑–æ–≤:
- `inner`
- `left\left`
- `full`
- `cross`

–ï—Å—Ç—å –Ω—é–∞–Ω—Å—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `ANY JOIN` - –æ–ø–µ—Ä–∞—Ç–æ—Ä ANY –æ—Ç–∫–ª—é—á–∞–µ—Ç –¥–µ–∫–∞—Ä—Ç–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, —Ç–æ –µ—Å—Ç—å –Ω–µ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø–æ –∫–æ–ª–æ–Ω–∫–µ –ø–æ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ, 
–∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –ø–æ–ø–∞–≤—à–∞—è—Å—è.

### Tasks

1. 
```
–î–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –Ω–∞ JOIN. 
–£ –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Å –≤—ã—Ä—É—á–∫–æ–π –≤ —Ä—É–±–ª—è—Ö –∏ —Ç–∞–±–ª–∏—Ü–∞ —Å –∫—É—Ä—Å–æ–º USD-RUB. 
–û–±—ä–µ–¥–∏–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ –≤—ã—Ä—É—á–∫—É –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö.    
```

![task_2_4_1_usd_rub.png](..%2F..%2Fimg%2Ftask_2_4_1_usd_rub.png)

–°–∫—Ä–∏–ø—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü [data_task_2_4_1.sql](sql%2Fmigrations%2Fdata_task_2_4_1.sql)

–†–µ—à–µ–Ω–∏–µ [task_2_4_1_usd_rub.sql](sql%2Fstaging%2Ftask_2_4_1_usd_rub.sql)

2. 
```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:

–ü–æ–ø—Ä–∞–∫—Ç–∏–∫—É–µ–º—Å—è –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ CROSS JOIN, 
–≤–∞—à–∞ –∑–∞–¥–∞—á–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü rank –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —á–∏—Å–ª—É –∏–∑ —á–∏—Å–ª–æ–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞, –ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ. –î–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É —á–∞—Å—Ç–æ –¥–∞—é—Ç –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö. –†–µ—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ CROSS JOIN –∏ GROUP BY . 
–ü–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–∞—Å—Å–∏–≤–∞–º–∏ –∏–ª–∏ –æ–∫–æ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –≤ –¥–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ–ª—å–∑—è.
```

![task_2_4_2_cross_join.png](..%2F..%2Fimg%2Ftask_2_4_2_cross_join.png)

–ù–µ–º–Ω–æ–≥–æ ü§Ø –∏ —Ä–µ—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ [task_2_4_2_rank.sql](sql%2Fstaging%2Ftask_2_4_2_rank.sql)
  

### –†–µ–¥–∫–∏–µ —Ç–∏–ø—ã JOIN

- `SEMI JOIN` - –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –ª–µ–≤–æ–π –∏ –ø—Ä–∞–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ –µ—Å–ª–∏ –≤ –ø—Ä–∞–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å 2 —Å—Ç—Ä–æ–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω—ã —Å –ª–µ–≤–æ–π, 
—Ç–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–µ–∫–∞—Ä—Ç–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏ —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Å—Ç—Ä–æ–∫–∞. 
- `ANTI JOIN` - –±–µ—Ä–µ–º –ª–µ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—ë —á—Ç–æ –Ω–µ –±—ã–ª–æ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–∞–≤–æ–π.
- `ASOF JOIN` - –Ω–µ—á–µ—Ç–∫–∏–π JOIN
–î–∞–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–ª–∏—è–Ω–∏—è —Ç–∞–±–ª–∏—Ü –±—É–¥–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ø–æ –±–ª–∏–∂–∞–π—à–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ ASOF JOIN:
- –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≥–æ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∏–ø–æ–≤: Int, UInt, Float, Date, DateTime, Decimal.
- –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º —Å—Ç–æ–ª–±—Ü–æ–º –≤ —Å–µ–∫—Ü–∏–∏ JOIN.

–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ASOF [data_asof_join.sql](sql%2Fmigrations%2Fdata_asof_join.sql)

–í—ã–ø–æ–ª–Ω–∏–≤ –∑–∞–ø—Ä–æ—Å:

```sql
select *,
       t2.dt
from join_table1 t1
asof left join join_table2 t2
using(id, dt);
```

–ü–æ–ª—É—á–∞–µ–º, –¥–ª—è –≤—Ç–æ—Ä–æ–π –∑–∞–ø–∏—Å–∏ —Å id=3, –¥–ª—è 4 —è–Ω–≤–∞—Ä—è –ø–æ–ª—É—á–∞–µ–º –Ω–µ—á–µ—Ç–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å 3 —è–Ω–≤–∞—Ä—è:

![asof_join.png](..%2F..%2Fimg%2Fasof_join.png)

### Tasks

1.
```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–î–∞–≤–∞–π—Ç–µ –æ—Ü–µ–Ω–∏–º –∫–∞–∫ –º–µ–Ω—è–ª–∏—Å—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–µ –æ—Ç –≥–æ–¥–∞ –∫ –≥–æ–¥—É –¥–ª—è –ø—Ä–∏—Å—Ç–∞–≤–æ–∫ PS3, PS2, X360, Wii.

–ù—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –∫–∞–∫–∏–µ –±—ã–ª–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –∫–∞–∂–¥—ã–π –≥–æ–¥ –ø–æ—Å–ª–µ —á–µ–≥–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º –≥–æ–¥–æ–º. 
–î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–∞–º—É —Å —Å–æ–±–æ–π —Ç–∞–∫ —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ –±–ª–∏–∂–∞–π—à–∏–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π 
(–≤–æ–∑–º–æ–∂–Ω–æ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏, –Ω–µ –æ–±—Ä–∞—â–∞–π—Ç–µ –Ω–∞ —ç—Ç–æ –≤–Ω–∏–º–∞–Ω–∏—è) –≥–æ–¥ –±—ã–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–ü–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑—å–º–∏—Ç–µ —Å—É–º–º—É –æ—Ç —Å—Ç–æ–ª–±—Ü–∞ —Ä–∞–∑–Ω–∏—Ü—ã —Ç–µ–∫—É—â–µ–≥–æ –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥–æ–¥–∞. 
–£ –≤–∞—Å –ø–æ–ª—É—á–∏—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –≤–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ –º–æ–¥—É–ª—é –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
```

–¢–µ—Å—Ç–æ–≤–∞—è VIEW

```sql
create view video_game_sales_view as select * from video_game_sales limit 200;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞
![task_2_4_3_diff_sales.png](..%2F..%2Fimg%2Ftask_2_4_3_diff_sales.png)

–°–∫—Ä–∏–ø—Ç —Ä–µ—à–µ–Ω–∏—è [task_2_4_3_sales_asof.sql](sql%2Fstaging%2Ftask_2_4_3_sales_asof.sql)

**UPD** –ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–µ–µ –∏ —á—É—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ –¥–µ–ª–∞—Ç—å —Ç–∞–∫:
```sql
asof join t1 as t2
on t1.Platform = t2.Platform and t1.Year > t2.Year
```

### UNION

–ï—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –Ω—é–∞–Ω—Å, –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `UNION DISTINCT`


## Control task

```
–í –¥–∞–Ω–Ω–æ–º –∑–∞–¥–∞–Ω–∏–∏ –Ω–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã—á–∏—Å–ª–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å 
–≤—ã–∂–∏—Ç—å –Ω–∞ –¢–∏—Ç–∞–Ω–∏–∫–µ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∏ –≤—ã—è—Å–Ω–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π 
–∏–∑ —Ç–µ—Ö —É –∫–æ–≥–æ –±—ã–ª–∏ —Å–∞–º—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–Ω—Å—ã –Ω–∞ —Å–ø–∞—Å–µ–Ω–∏–µ –≤ –∏—Ç–æ–≥–µ –≤—ã–∂–∏–ª. 
–ó–∞–¥–∞–Ω–∏–µ –±–æ–ª—å—à–æ–µ! –®–∞–≥–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ:

–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏–≤–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä –∏–ª–∏ –Ω–µ—Ç: Pclass, Sex, Age
–î–ª—è –ø–æ–ª—è Age –Ω–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ç–∏–ø –≤–æ Float –ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –Ω—É–∂–Ω–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–ø–æ—Å–æ–±–æ–º: –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º avg (–±–µ–∑ —É—á–µ—Ç–∞ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
–ù–∞ –≤—ã—Ö–æ–¥–µ –≤—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ç–∞–∫–∏–º–∏ –ø–æ–ª—è–º–∏: Pclass, Sex, Age, Survived
–î–ª—è –ø–æ–ª—è Age –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–µ–π roundAge() –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –¥–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø
–ü–æ—Å–ª–µ —á–µ–≥–æ –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏—Ç—å –ø–æ –ø–æ–ª—è–º Pclass, Sex, Age.  –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ 

x= count(AllUser)/count(SurvivedUser) –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø–µ
  
–°–¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç–µ —É –∫–æ–≥–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏—Ç—å > 0.1 –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è lucky –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω—É—é—Ç—Å—è other
–î–∞–ª–µ–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ç–∞–±–ª–∏—Ü–µ–π –¢–∏—Ç–∞–Ω–∏–∫ —á—Ç–æ–±—ã –≤—ã—è—Å–Ω–∏—Ç—å –∫–∞–∫–∏–µ —à–∞–Ω—Å—ã –≤—ã–∂–∏—Ç—å –µ—Å—Ç —å—É –∫–∞–∂–¥–æ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏.
–ü–æ—Å–ª–µ —á–µ–≥–æ –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ other –∫–æ–º—É —É–¥–∞–ª–æ—Å—å –≤—ã–∂–∏—Ç—å
–ü–æ–ª—É—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–≤–µ—Ç–æ–º
```

–¢–µ—Å—Ç–æ–≤–∞—è VIEW

```sql
create view titanic_view as select * from titanic order by PassengerId limit 200;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞
![chapter_2_final_titanic.png](..%2F..%2Fimg%2Fchapter_2_final_titanic.png)

–†–µ—à–µ–Ω–∏–µ [final_task_chapter_2_titanic_prob.sql](sql%2Fstaging%2Ffinal_task_chapter_2_titanic_prob.sql)


## –ú–∞—Å—Å–∏–≤—ã. –ß–∞—Å—Ç—å 1

–ò–∑ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ:
- –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–æ–ª–±–µ—Ü –º–∞—Å—Å–∏–≤–∞, —Ç–æ —Ç–∏–ø `Array(UInt64)`
- –º–∞—Å—Å–∏–≤ - —ç—Ç–æ –Ω–∞–±–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞
- `tokens` - —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–±–∏–≤–∞—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏, –∏—Å–ø–æ–ª—å–∑—É—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –Ω–µ –±—É–∫–≤–µ–Ω–Ω–æ-—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã ASCII

### Tasks

```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–î–ª—è —Ç–∞–±–ª–∏—Ü—ã –¢–∏—Ç–∞–Ω–∏–∫. –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫—Ç–æ –∏–∑ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –∑–∞—Å–µ–ª–∏–ª—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤. –î–ª—è —ç—Ç–æ–≥–æ

–†–∞–∑–æ–±—å–µ–º –∫–æ–ª–æ–Ω–∫—É Cabin –Ω–∞ –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
–û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É –º–∞—Å—Å–∏–≤–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
–ù–∞–ø—Ä–∏–º–µ—Ä –∏–∑ C23 F C25 C27 –ø–æ–ª—É—á–∞–µ–º [23, "F", 25, 27]

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç –≤–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –∫—É–ø–ª–µ–Ω–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω–æ–º–µ—Ä–æ–≤.
```

–†–µ—à–µ–Ω–∏–µ [task_2_5_1_arrays.sql](sql%2Fstaging%2Ftask_2_5_1_arrays.sql)

---------------------------------
## –ú–∞—Å—Å–∏–≤—ã. –ß–∞—Å—Ç—å 2

–ì–æ—Ç–æ–≤–∏–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ [make_table_and_data_array_p2.sql](sql%2Fmigrations%2Fmake_table_and_data_array_p2.sql)

–ò–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:
```sql
select food_type,
       arrayFilter(x-> x > 10, arrayMap(x-> toFloat32(replaceRegexpAll(x, '–º–ª|–≥', '')), groupArray(count_0_2)))
from food
group by food_type;
```

–£–∑–Ω–∞–µ–º –ø–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `groupArray` - —Å–æ–±–∏—Ä–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–∞—Å—Å–∏–≤ (—Ç–∞–∫–æ–µ –º—ã –≤–∏–¥–µ–ª–∏ —É–∂–µ –≤ Postgres)
- `replaceRegexpAll` - –∫–ª–∞—Å—Å–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫, –∑–∞–º–µ–Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω–∞ —á—Ç–æ-—Ç–æ
- `arrayMap\arrayFilter` - –∫–∞–∫ Python-lambda, —Ç–æ–ª—å–∫–æ –≤ clickhouse, –Ω–µ –∏–Ω–∞—á–µ –º–∞–≥–∏—è üßô‚Äç‚ôÄÔ∏è
—Å–∏–Ω—Ç–∞–∫—Å–∏—Å 

```sql
arrayMap(x-> function(x), array)
```

- `arrayJoin` -  —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ –≤ —Å—Ç—Ä–æ–∫–∏, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ [pandas.DataFrame.explode](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.explode.html)

![arrayJoin_demo.png](..%2F..%2Fimg%2FarrayJoin_demo.png)

- –∏ –µ—â–µ –µ—Å—Ç—å –º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π `arraySort\arrayDifference\arrayCumsum\arrayEnumerate` –∏ –¥—Ä

### Tasks

```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–£ –Ω–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –Ω–æ –∫–∞–∫ —ç—Ç–æ –æ–±—ã—á–Ω–æ –±—ã–≤–∞–µ—Ç –≤ –∂–∏–∑–Ω–∏, –Ω–µ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–æ—Ö–æ–¥—è—Ç –¥–æ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã, –∏ —ç—Ç–æ –±–æ–ª—å—à–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –º–æ–∂–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –û–¥–Ω–∞–∫–æ –¥–ª—è —á–∞—Å—Ç–∏ —Å–æ–±—ã—Ç–∏–π –º—ã –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É.
–î–æ–ø—É—Å—Ç–∏–º –Ω–∞—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –∫—É–ø–∏—Ç—å —á—Ç–æ —Ç–æ –Ω–∞ —Å–∞–π—Ç–µ, –∏ –º—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ–º —á—Ç–æ –æ–Ω –Ω–µ —Å–º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π —à–∞–≥ –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ. –ò—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–æ–≥–æ –º—ã –º–æ–∂–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å–≤–æ–µ –≤—Ä–µ–º—è —è —Ä–µ—à–∞–ª —Ç–∞–∫—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤).

–í–∞—à–∞ –∑–∞–¥–∞—á–∞ –≤ —ç—Ç–æ–º –∑–∞–¥–∞–Ω–∏–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–ø—É—â–µ–Ω—ã, —É –Ω–∞—Å –µ—Å—Ç—å uid (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) –∏ step_ (–∏–º—è —à–∞–≥–∞, —Å–æ–±—ã—Ç–∏—è). –®–∞–≥–∏ –ø–æ–º–µ—á–µ–Ω—ã –Ω–æ–º–µ—Ä–∞–º–∏, –æ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π, —Ç–æ –µ—Å—Ç—å –∏–¥—É—Ç –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º. –ù–æ —á–∞—Å—Ç—å –∏–∑ –Ω–∏—Ö –ø—Ä–æ–ø—É—â–µ–Ω–∞, –Ω—É–∂–Ω–æ –∏—Ö –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å. –ù–∞–º –∏–∑–≤–µ—Å—Ç–Ω–æ —á—Ç–æ —É –Ω–∞—Å 9 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏ —Ç–∞–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤

step a (1 —à–∞–≥)
step b
step c
step d
step e
step f
step g
step w (–ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥)
–£ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ —Å–≤–æ–π! –í –∑–∞–¥–∞–Ω–∏–∏ –Ω–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CROSS JOIN

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—É–º–º—É –ø–æ —Å—Ç–æ–ª–±—Ü—É UID
```

–û–∫—Ä—É–∂–µ–Ω–∏–µ [make_view_and_data_2_5_2_events.sql](sql%2Fmigrations%2Fmake_view_and_data_2_5_2_events.sql)


–ü—Ä–∏–º–µ—Ä, —Ä–µ—à–µ–Ω–∏—è:

![task_2_5_2_example.png](..%2F..%2Fimg%2Ftask_2_5_2_example.png)


–†–µ—à–µ–Ω–∏–µ [task_2_5_2_aarays.sql](sql%2Fstaging%2Ftask_2_5_2_aarays.sql)

------------------------------
## –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

![window_functions_in_click.png](..%2F..%2Fimg%2Fwindow_functions_in_click.png)

–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–≤–µ–∑–ª–∏ –Ω–µ —Ç–∞–∫ –¥–∞–≤–Ω–æ, –Ω–æ —Ç—É—Ç –Ω–∏ —á–µ–≥–æ –Ω–æ–≤–æ–≥–æ, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∏ –≤ Postgres.

–ú–æ–∂–Ω–æ —Å—Ö–æ–¥–∏—Ç—å –ø–æ–≥–ª—è–¥–µ—Ç—å –≤ [–¥–æ–∫—É](https://clickhouse.com/docs/en/sql-reference/window-functions#moving--sliding-average-per-3-rows)

#### Offtop

–ü—Ä–∏ –≥—É–ª—è–Ω–∏–∏ –ø–æ –¥–æ–∫–µ clickhouse –Ω–∞—à–ª–∞—Å—å –∑–∞–±–∞–≤–Ω–∞—è —Ñ—É–∫–Ω—Ü–∏—è [bar](https://clickhouse.com/docs/ru/sql-reference/functions/other-functions#function-bar), –æ–Ω–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç
—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–æ–ª–±—á–∞—Ç—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ ü§ò:

![bar_function.png](..%2F..%2Fimg%2Fbar_function.png)

## Tasks

```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:
–î–ª—è —Ç–∞–±–ª–∏—Ü—ã –¢–∏—Ç–∞–Ω–∏–∫, –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ —à–∞–Ω—Å—ã –≤—ã–∂–∏—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å—Ö–æ–¥—è 
–∏–∑ –µ–≥–æ –ø–æ–ª–∞ –∏ –∫–ª–∞—Å—Å–∞ 

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–∞ –≤–ø–∏—à–∏—Ç–µ –∏–º—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞ —É –∫–æ—Ç–æ—Ä–æ–≥–æ —à–∞–Ω—Å –≤—ã–∂–∏—Ç—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ, 
–æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ –∏–º–µ–Ω–∏ –µ—Å–ª–∏ —Ç–∞–∫–∏—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ [A -> Z]. 
–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN –¢–æ–ª—å–∫–æ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.
```

–†–µ—à–µ–Ω–∏–µ [task_2_5_3_titanic_surv.sql](sql%2Fstaging%2Ftask_2_5_3_titanic_surv.sql)

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ—à–µ–Ω–∏—è –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –Ω–µ–ª—å–∑—è –¥–µ–ª–∏—Ç—å –æ–¥–Ω—É –æ–∫–æ–Ω–∫—É –Ω–∞ –¥—Ä—É–≥—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫:

```sql
sum(1) over(partition by date) / count(1) over(partition by date)
```
–í—ã–ª–µ—Ç–∞–µ—Ç –æ—à–∏–±–∫–∞ `UNKNOWN IDENTIFIER`ü§∑‚Äç‚ôÇÔ∏è

-------------------------------
## –ê–Ω–∞–ª–æ–≥–∏ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

–î–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –æ–∫–æ–Ω–æ–∫ –≤ –∫–ª–∏–∫–µ –±—ã–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–Ω–∞–ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- `neighbor` - —Å–¥–≤–∏–≥ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `lag\lead`
- `rowNumberInBlock` - —Ç–∏–ø–∞ `row_number` —Ç–æ–ª—å–∫–æ –Ω–µ –¥–ª—è `PARTITION`, –∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä–æ–≥–æ –±–ª–æ–∫–∞ (—É–∑–Ω–∞–µ–º –ø–æ–∑–∂–µ)
- `runningDifference` - —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ç–µ–∫—É—â–µ–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π (–¥–ª—è –ø–µ—Ä–≤–æ–π –±—É–¥–µ—Ç 0)

### Tasks

```
–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:

–í –Ω–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å –ª–æ–≥–∏–Ω–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, 
–º—ã —Å–Ω–∏–º–∞–µ–º –ª–æ–≥ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤ —Å–µ—Ç–∏. 
–ü–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–≥–æ –≤–∏–¥–∞
```
![task_2_5_4_sessions.png](..%2F..%2Fimg%2Ftask_2_5_4_sessions.png)

```
–ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –∑–∞—Ö–æ–¥–∞–º–∏ –±–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç, 
—Ç–æ –∑–Ω–∞—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é. 
–í–∞—à–∞ –∑–∞–¥–∞—á–∞ —Ä–∞–∑–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–æ –µ—Å—Ç—å –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –Ω–æ–º–µ—Ä –æ—Ç 1 –¥–æ N.
–ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 1 
```

–ì–æ—Ç–æ–≤–∏–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ [make_data_2_5_4_sessions.sql](sql%2Fmigrations%2Fmake_data_2_5_4_sessions.sql)

–†–µ—à–µ–Ω–∏–µ [task_2_5_4_sessions.sql](sql%2Fstaging%2Ftask_2_5_4_sessions.sql)

--------------------------------
## –î—Ä—É–≥–∏–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

